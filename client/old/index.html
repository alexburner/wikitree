<html>
<head>
    <!-- manifesto @ http://goo.gl/e8Ams -->
    <meta charset="UTF-8">
    <script>if(!(console&&console.log)){console={log:function(){}};}</script>
    <title>wikitree redux</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="author" content="Alex Burner">
    <meta name="description" content="Wikitree allows you to wander through the links of Wikipedia and creates an interactive visual representation of your journey. It's like a map. Currently under development.">
    <style type="text/css">
        body {
            background-color: #EEE;
            margin: 0;
            padding: 20px;
        }
        .node {
            width: 220px;
            min-height: 60px;
            position: relative;
            margin: 1px;
            /*margin: 6px 0;*/
            /*padding: 1px 0;*/
        }
        .node-content {
            padding: 10px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #FFF;
        }
        a.node-content {
            display: block;
            cursor: pointer;
            text-decoration: none;
            -webkit-transition: all 0.1s ease;
               -moz-transition: all 0.1s ease;
                 -o-transition: all 0.1s ease;
                    transition: all 0.1s ease;
        }
        a.node-content:hover,
        a.node-content:focus {
            padding: 12px;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            background-color: #FFFEEE;
        }
        .node-content > h5 {
            line-height: 1em;
        }
        .full-article {
            min-width: 700px;
            position: absolute;
            top: -2px; left: 30px;
            z-index: 1001;
            padding: 10px;
            background-color: #FFF;
            border: 1px solid #999;
            border-radius: 2px;
            -webkit-box-shadow: 0px 0px 6px #888; /* Saf3-4 */
               -moz-box-shadow: 0px 0px 6px #888; /* FF3.5 - 3.6 */
                    box-shadow: 0px 0px 6px #888; /* Opera 10.5, IE9, FF4+, Chrome 10+ */
        }
        a.close_button {
            display: block;
            cursor: pointer;
            text-decoration: none;
            width: 30px;
            background-color: #F00;
            color: #FFF;
            font-family: sans-serif;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            line-height: 1.5em;
        }

        /**
         * Special root node stuff
         */

        #root {
            min-height: 400px;
        }

        #searchForm {
            margin: 16px auto;
        }
        #searchForm input {
            width: 200px;
            height: 32px;
            margin: 4px 0;
        }
        #searchForm button {
            width: 200px;
            height: 32px;
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div id="wikitree">
        <div id="root" class="node">
            <div class="node-content">
                <a href="http://www.wikipedia.org" title="Wikipedia, The Free Encyclopedia">
                    <img src="/img/wikipedia_logo.png" alt="Wikipedia Logo" />
                </a>
                <form id="searchForm">
                    <input id="searchField" type="text" class="span3" placeholder="Enter an article title" />
                    <button id="addBranch" class="btn success">Add Branch</button>
                    <button id="resetTree" class="btn danger">Reset Tree</button>
                </form>
            </div>
        </div>
    </div>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script>

        // THIRD-PARTY JS (might be modified)

        /*
         * Title Caps
         *
         * Ported to JavaScript By John Resig - http://ejohn.org/ - 21 May 2008
         * Original by John Gruber - http://daringfireball.net/ - 10 May 2008
         * License: http://www.opensource.org/licenses/mit-license.php
         */

        (function(){
            var small = "(a|an|and|as|at|but|by|en|for|if|in|of|on|or|the|to|v[.]?|via|vs[.]?)";
            var punct = "([!\"#$%&'()*+,./:;<=>?@[\\\\\\]^_`{|}~-]*)";
            this.titleCaps = function(title){
                if (typeof title !== 'string') { return ''; }
                title = underspace(title); /* burnered */
                var parts = [], split = /[:.;?!] |(?: |^)["Ò]/g, index = 0;
                while (true) {
                    var m = split.exec(title);
                    parts.push( title.substring(index, m ? m.index : title.length)
                        .replace(/\b([A-Za-z][a-z.'Õ]*)\b/g, function(all){
                            return /[A-Za-z]\.[A-Za-z]/.test(all) ? all : upper(all);
                        })
                        .replace(RegExp("\\b" + small + "\\b", "ig"), lower)
                        .replace(RegExp("^" + punct + small + "\\b", "ig"), function(all, punct, word){
                            return punct + upper(word);
                        })
                        .replace(RegExp("\\b" + small + punct + "$", "ig"), upper));
                    index = split.lastIndex;
                    if ( m ) parts.push( m[0] );
                    else break;
                }
                return parts.join("").replace(/ V(s?)\. /ig, " v$1. ")
                    .replace(/(['Õ])S\b/ig, "$1s")
                    .replace(/\b(AT&T|Q&A)\b/ig, function(all){
                        return all.toUpperCase();
                    });
            };
            function lower(word){
                return word.toLowerCase();
            }
            function upper(word){
              return word.substr(0,1).toUpperCase() + word.substr(1);
            }
            function underspace(title) {
                return title.replace(/_/g, ' ');
            }
        })();

        // courtesy Mark Pilgrim via Dive Into HTML5
        function supports_html5_storage() {
          try {
            return 'localStorage' in window && window['localStorage'] !== null;
          } catch (e) {
            return false;
          }
        }
    </script>
    <script>
        //
        // NAMESPACE
        var ob = {};


        //
        // TREE MODULE
        ob.tree = (function () {
            // VARIABLES
            var root;
            // ELEMENTS
            var elWindow, elAddBranch, elResetTree, elSearchField, elTree;
            // SETUP METHODS
            var init = function () {
                findElements();
                addEventListeners();
                buildRoot();
                reconstructArchive();
            };
            var findElements = function () {
                elTree = $('#wikitree');
                elRoot = $('#root');
                elSearchField = $('#searchField');
                elAddBranch = $('#addBranch');
                elResetTree = $('#resetTree');
            };
            var addEventListeners = function () {
                elAddBranch.bind('click', handleAddBranch);
                elResetTree.bind('click', handleResetTree);
            };
            var buildRoot = function () {
                root = {};
                root.children = [];
                root.element = elRoot;
                root.getChildCount = function () {
                    return root.children.length;
                };
                root.getChildAt = function (index) {
                    if (!(root.children.length && root.children.length > index)) { return; }
                    return root.children[index];
                };
                root.addChild = function (title) {
                    if (typeof title !== 'string') { return; }
                    var child = new Node({
                        parent: root,
                        title: title,
                        level: 2
                    });
                    root.children.push(child);
                    setTimeout(child.openFull, 400);
                    saveArchive();
                };
                root.reconstructChild = function (title) {
                    if (typeof title !== 'string') { return; }
                    var child = new Node({
                        parent: root,
                        title: title,
                        level: 2
                    });
                    root.children.push(child);
                    return child;
                };
            };
            // TRAVERSAL METHODS
            var walkTree = function (methodName) {
                var walk = function (node) {
                    if (typeof node[methodName] === 'function') { node[methodName](); };
                    if (!node.getChildCount()) { return; }
                    for (var i = 0, len = node.getChildCount(); i < len; i++) {
                        walk(node.getChildAt(i));
                    }
                };
                walk(root);
            };
            var treeDepth = function () {
                var levels = 0;
                var walk = function (node, level) {
                    if (!node.getChildCount()) {
                        levels.push(level);
                    }
                    for (var i = 0, len = node.getChildCount(); i < len; i++) {
                        walk(node.getChildAt(i), level++);
                    }
                };
                walk(root, 1);
                var highestLevel = 1;
                for (var i = 0, len = levels.length; i < len; i++) {
                    if (levels[i] > highestLevel) { highestLevel = levels[i]; }
                }
                return highestLevel;
            };
            // ARCHIVAL METHODS
            var reconstructArchive = function () {
                ob.archive.reconstruct(root, 'fulltreemap');
            };
            var saveArchive = function () {
                ob.archive.save(root, 'fulltreemap');
            };
            var resetTree = function () {
                ob.archive.wipe('fulltreemap');
                location.reload();
            };
            // EVENT HANDLERS
            var handleAddBranch = function (e) {
                e.preventDefault();
                if (!elSearchField.val()) { return; }
                root.addChild(elSearchField.val());
            };
            var handleResetTree = function (e) {
                e.preventDefault();
                resetTree();
            };
            // INTERFACE
            return {
                init: init,
                walk: walkTree,
                depth: treeDepth,
                save: saveArchive
            };
        })();


        //
        // TREE ARCHIVER
        ob.archive = (function () {
            var getMap = function (key) {
                if (typeof key !== 'string') { return; }
                if (!supports_html5_storage()) { return; }
                var mapString = localStorage.getItem(key);
                if (!(mapString && typeof mapString === 'string' && mapString.length)) { return; }
                try {
                    var map = JSON.parse(mapString);

                    console.log(mapString);

                    return map;
                } catch (e) {

                    console.log(e);
                    console.log(e.message);

                }
            };
            var setMap = function (map, key) {
                if (typeof key !== 'string') { return; }
                if (!supports_html5_storage()) { return; }
                try {
                    var mapString = JSON.stringify(map);
                } catch (e) {

                    console.log(e);
                    console.log(e.message);

                }
                if (!(mapString && typeof mapString === 'string' && mapString.length)) { return; }
                localStorage.setItem(key, mapString);
            };
            var createMap = function (node) {
                if (!(node && node.children && node.children.length)) { return; }
                var map = {};
                var walk = function (node, map) {
                    if (!(node && node.children && node.children.length)) { return; }
                    map.children = [];
                    for (var i = 0, count = -1, len = node.children.length; i < len; i++) {
                        var child = node.children[i];
                        if (!(child && typeof child.title === 'string')) { continue; }
                        map.children.push({ title: child.title });
                        count++;
                        if (!(child.children && child.children.length)) { continue; }
                        walk(child, map.children[count]);
                    }
                };
                walk(node, map);
                return map;
            };
            var reconstructTree = function (root, map) {
                if (!(map && map.children && map.children.length)) { return; }
                var reconstruct = function (parent, mChildren) {
                    for (var i = 0, len = mChildren.length; i < len; i++) {
                        var mChild = mChildren[i];
                        if (!(mChild && typeof mChild.title === 'string')) { continue; }
                        var child = parent.reconstructChild(mChild.title);
                        if (!(child && mChild.children && mChild.children.length)) { continue; }
                        reconstruct(child, mChild.children);
                    }
                };
                reconstruct(root, map.children);
            };
            // INTERFACE
            return {
                save: function (root, key) {
                    if (typeof key !== 'string') { return; }
                    if (!supports_html5_storage()) { return; }
                    setMap(createMap(root), key);
                },
                reconstruct: function (root, key) {
                    if (typeof key !== 'string' ) { return; }
                    if (!supports_html5_storage()) { return; }
                    reconstructTree(root, getMap(key));
                },
                wipe: function (key) {
                    if (typeof key !== 'string') { return; }
                    if (!supports_html5_storage()) { return; }
                    localStorage.setItem(key, '');
                }
            };
        })();


        //
        // NODE CONSTRUCTOR
        // args = { parent, title, level }
        function Node(args) {
            // PUBLIC VARIABLES
            var self = this;                   // constructed object
            self.title = args.title;           // article title
            self.intro = args.intro;           // article introduction
            self.level = args.level;           // depth within tree
            self.parent = args.parent;         // parent node
            self.children = [];                // child nodes
            // PRIVATE ELEMENTS
            var elNode, elThumb, elFull, elContent, elClose;
            // PRIVATE METHODS
            var init = function () {
                buildHumanTitle();
                buildElements();
                addEventListeners();
                getContent();
                showNode();
            };
            var buildHumanTitle = function () {
                if (typeof self.title !== 'string') { return; }
                if (typeof self.humanTitle !== 'string') {
                    self.humanTitle = titleCaps(self.title);
                }
            };
            var buildElements = function () {

                // TODO separate build and assembly

                elNode = $('<div class="node"></div>').hide().appendTo(self.parent.element);
                elThumb = $('<a class="node-content"></a>').css({'z-index':1000-self.level}).hide().appendTo(elNode);
                elThumb.prepend('<h5>'+self.humanTitle+'</h5>');
                elFull = $('<div class="full-article"></div>').hide().appendTo(elNode);
                elClose = $('<a class="close_button">X</a>').appendTo(elFull);
                elFull.append('<h1>'+self.humanTitle+'</h1>');
                elContent = $('<div class="node_content"></div>').appendTo(elFull);
                self.element = elNode;
            };
            var getContent = function () {
                if (typeof self.title !== 'string') { return; }
                $.getJSON('https://en.wikipedia.org/w/api.php?action=parse&format=json&callback=?', {
                    page: self.title,
                    prop:'text'
                }, getSuccess);

                // TODO: loading animation & error handling

            };
            var getSuccess = function (data) {
                if (data && data.error && data.error.info) { alert(data.error.info); }
                if (!(data && data.parse && data.parse.text && data.parse.text['*'])) { return; }
                elContent.html(data.parse.text['*']);
                elContent.find('a').bind('click', wikiLinkOverride);
                //var intro = elContent.children('p').eq(0).html();
                //if (intro) { elThumb.prepend('<p>'+intro+'</p>'); }

                // TODO: foolproof external link override
                // elContent.find('a').attr('target', '_blank');

            };
            var showNode = function () {
                elNode.show();
                elThumb.show(400);
                elNode.animate({ left: 220 }, 400);
            };
            var createChild = function (title) {
                if (typeof title !== 'string') { return; }
                var child = new Node({
                    parent: self,
                    title: title,
                    level: self.level + 1
                });
                self.children.push(child);
                setTimeout(child.openFull, 400);
                ob.tree.save();
            };
            // EVENT HANDLERS
            var addEventListeners = function () {
                elThumb.bind('click', thumbClick);
                elClose.bind('click', closeClick);
            };
            var wikiLinkOverride = function (e) {
                if (!(e && e.currentTarget && e.currentTarget.pathname)) { return; }
                if (e.currentTarget.pathname.indexOf('/wiki/') === -1) { return; }
                e.preventDefault();
                createChild(decodeURI(e.currentTarget.pathname.substr(6)));
                self.closeFull();
            };
            var thumbClick = function (e) {
                self.openFull();
            };
            var closeClick = function (e) {
                if (!e) { return; }
                e.preventDefault();
                self.closeFull();
            };
            // PUBLIC METHODS
            this.reconstructChild = function (title) {
                if (typeof title !== 'string') { return; }
                var child = new Node({
                    parent: self,
                    title: title,
                    level: self.level + 1
                });
                self.children.push(child);
                return child;
            };
            this.getChildCount = function () {
                return self.children.length;
            };
            this.getChildAt = function (index) {
                if (!(self.children.length && self.children.length > index)) { return; }
                return self.children[index];
            };
            this.openFull = function () {
                ob.tree.walk('closeFull');
                elFull.show(400);
            };
            this.closeFull = function () {
                elFull.hide(200);
            };
            // FIRST EXECUTION
            init();
        }


        //
        // DOCUMENT READY ? EXECUTION
        $(function(){ob.tree.init();});
    </script>
</body>
</html>

<!--


    TODO LIST

    > extend node class
      default, search results, third-party page, etc
      ejohn.org/blog/simple-javascript-inheritance/
    > implement wikipedia search api
      http://www.mediawiki.org/wiki/API:Opensearch
    > tree reconstruction
      stringify and store tree with localStorage, walk & rebuild if exists
      http://mislav.uniqpath.com/diveintohtml5/storage.html
      SIMPLE RESET - flush localStorage, hard refresh page
    > deletable nodes
      nodes need public "remove" method
    > reset tree data and DOM
      should be able to clear/reset tree (current nodes, saved tree)
    > bring opened article to top/left of window
    > better animations for adding nodes & open/close articles
      make nodes tangible physical organic holonic
      make each node morph between its two states
    > better handling for super long titles
      get height of title element (not tile, title) and use to calculate height of .node
      example: Night of the Day of the Dawn of the Son of the Bride of the Return of the Revenge of the Terror of the Attack of the Evil, Mutant, Alien, Flesh Eating, Hellbound, Zombified Living Dead Part 2: In Shocking 2-D
    > better api error handling (page not found, redirects, etc)
    > actual close button
    > body padding solution
    > loading indicators
      people want to feel in control
      give them efficacy
      let them know their actions are heard


-->