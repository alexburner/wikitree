<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Wikitree</title>
    <link rel="stylesheet" type="text/css" href="/css/legacy.css">
    <link rel="stylesheet" type="text/css" href="/lib/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/lib/font-awesome/css/font-awesome.min.css">
    <style type="text/css">


        .overlay#reader {
            width: 700px;
        }

        .overlay#menu {
            left: -270px;
            display: none;
        }
        .menu-item.header .open-button {
            /*visibility: visible;*/
        }

        g.node.active circle {
            stroke-width: 36px;
        }

        g.node.active text.title {
            font-size: 48px;
        }


        #ischool {
            width: 30px;
            height: 30px;
            position: fixed;
            left: 15px;
            bottom: 15px;
            z-index: 10000;
        }



    </style>
</head>
<body>

    <img id="ischool" src="/img/ischool.png">

    <div class="main">
        <div id="map">
            <div id="space-graph">
                <div class="scroller">
                    <div class="scrolled">
                        <div class="content">
                            <!-- SVG inserts here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="reader" class="overlay">
            <div class="inner">
                <div class="search">
                    <div class="w">
                        <img src="/img/w.png">
                    </div>
                    <div class="bar">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search for a Wikipedia article...">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="article">
                    <iframe id="article-frame" width="100%" height="100%" src="/poster/article.html">
                    </iframe>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="/lib/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/lib/d3/d3.min.js"></script>
    <script type="text/javascript">



        /**
         * Activate scroll-to-drag on a .scroller/.scrolled pair
         *
         * @param  {HTMLElement} containerEl    Element to find pair in
         * @requires jQuery as $
         */
        function dragToScroll(containerEl) {

            // find target elements
            var $container = $(containerEl);
            var $scroller = $container.find('.scroller');
            var $scrolled = $container.find('.scrolled');

            // scroll to center
            $scroller.scrollLeft(
                $scrolled.width() / 2 -
                $scroller.width() / 2 +

                // hacky? center x in respect to reader
                // todo: half n half for map n reader
                $('#reader').width() / 2

            );
            $scroller.scrollTop(
                $scrolled.height() / 2 -
                $scroller.height() / 2
            );

            // start drag
            $scrolled.on('mousedown', function (e) {
                // attach current position as data
                $scrolled.data('pan', {
                    'pageX': e.pageX,
                    'pageY': e.pageY,
                    'scrollX': $scroller.scrollLeft(),
                    'scrollY': $scroller.scrollTop()
                });
                // handle drag on any movement
                $scrolled.on('mousemove', dragHandler);
                // release drag handler on next mouseup
                $(document).one('mouseup', function (e) {
                    $scrolled.unbind('mousemove', dragHandler);
                });
            });

            // during drag
            function dragHandler(e) {
                e.preventDefault();
                // grab previous position
                var prev = $scrolled.data('pan');
                // calculate position change
                var deltaX = e.pageX - prev.pageX;
                var deltaY = e.pageY - prev.pageY;
                // update scroll position
                var scrollX = prev.scrollX - deltaX;
                var scrollY = prev.scrollY - deltaY;
                $scroller.scrollLeft(scrollX);
                $scroller.scrollTop(scrollY);
            }

        }

        // add dragging to space graph
        dragToScroll(document.getElementById('space-graph'));






        /**
         * Force graph playtime
         */

        // enter, update, exit - http://bost.ocks.org/mike/join
        // simple graph - http://bl.ocks.org/sathomas/11550728
        // build graph - http://bl.ocks.org/mbostock/929623
        // resizable - http://bl.ocks.org/mbostock/3355967
        // drag + zoom - http://bl.ocks.org/mbostock/6123708

        var forceGraph = (function () {

            var width = 100;
            var height = 100;

            var zoom = d3.behavior.zoom()
                .scaleExtent([0.2, 10])
                .on('zoom', function () {
                    container.attr(
                        'transform',
                        'translate(' + d3.event.translate + ')' +
                        'scale(' + d3.event.scale + ')'
                    );
                });

            var svg = d3.select('#map .content')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            var rect = svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .style('fill', 'none')
                .style('pointer-events', 'all')
                .call(zoom)
                .on('dblclick.zoom', null);

            var container = svg
                .append('g');

            var force = d3.layout.force()
                .linkDistance(60)
                .charge(-360)
                .gravity(0.01)
                .on('tick', tick);

            var links = force.links();
            var nodes = force.nodes();

            var linkSelection = container
                .append('svg:g')
                .attr('class', 'links')
                .selectAll('line.link');
            var nodeSelection = container
                .append('svg:g')
                .attr('class', 'nodes')
                .selectAll('g.node');


            function resize(w, h) {
                // update globals
                width = w;
                height = h;
                // update elements
                svg
                    .attr('width', width)
                    .attr('height', height);
                rect
                    .attr('width', width)
                    .attr('height', height);
                force
                    .size([width, height])
                    .resume();
            }


            var isDragging = false;
            var nodeDrag = d3.behavior.drag()
                .on('dragstart', function (d, i) {
                    d3.event.sourceEvent.stopPropagation();
                })
                .on('drag', function (d, i) {
                    if (!isDragging) {
                        d.fixed = true;
                        isDragging = true;
                    }
                    force.start();
                    d3.event.sourceEvent.stopPropagation();
                    d.px += d3.event.x;
                    d.py += d3.event.y;
                    d.x += d3.event.x;
                    d.y += d3.event.y;
                    tick();
                })
                .on('dragend', function (d, i) {
                    d3.event.sourceEvent.stopPropagation();
                    if (isDragging) {
                        tick();
                        isDragging = false;
                    }
                });


            function tick() {
                linkSelection
                    .attr('x1', function(d) { return d.source.x; })
                    .attr('y1', function(d) { return d.source.y; })
                    .attr('x2', function(d) { return d.target.x; })
                    .attr('y2', function(d) { return d.target.y; });
                nodeSelection
                    .attr('transform', function(d) {
                        return 'translate(' + d.x + ',' + d.y + ')';
                    });
            }



            // hacky tracky
            var currIndex = null;




            function handleNodeClick(d, i) {
                currIndex = i;
                //loadFrame(d.title);

                nodeSelection.classed('active', function (d, i) {
                    return (i === 0);
                    //return (i === currIndex);
                });

            }

            function handleNodeDblclick(d, i) {
                d.fixed = false
                d3.select(this).classed('fixed', false);
                force.start();
            }

            function handleLabelClick(d, i) {
                currIndex = i;
                //loadFrame(d.title);

                nodeSelection.classed('active', function (d, i) {
                    return (i === 0);
                    //return (i === currIndex);
                });

            }

            // add new node to graph

            function addNode(title, sourceIndex) {

                addNodeData(title, sourceIndex);
                updateElements();

                var newIndex = nodes.length - 1;
                currIndex = newIndex;

                nodeSelection.classed('active', function (d, i) {
                    return (i === 0);
                    //return (i === currIndex);
                });

                return newIndex;
            }

            function addNodeData(title, sourceIndex) {

                // grab source node if index given
                var sourceNode = null;
                if (typeof sourceIndex === 'number') {
                    // pass -1 to make unconnected node
                    if (sourceIndex >= 0) {
                        sourceNode = nodes[sourceIndex];
                    }
                } else if (typeof currIndex === 'number') {
                    sourceNode = nodes[currIndex];
                }

                // make a new node
                var title = title || '';
                var newNode = {
                    index: nodes.length,
                    title: title
                };
                // set new node origin
                if (sourceNode) {
                    newNode.x = sourceNode.x + getJitter(10);
                    newNode.y = sourceNode.y + getJitter(10);
                } else {
                    var size = force.size();
                    newNode.x = size[0] / 2 + getJitter(10);
                    newNode.y = size[1] / 2 + getJitter(10);
                }

                // store new node reference
                nodes.push(newNode);
                // link new node to source node?
                if (sourceNode) {
                    links.push( {
                        index: links.length,
                        source: sourceNode,
                        target: newNode
                    });
                }

            }

            function updateElements() {

                // update link elements
                linkSelection = linkSelection.data(links);
                linkSelection
                    .enter()
                        .append('svg:line')
                        .attr('class', 'link');

                // update node elements
                nodeSelection = nodeSelection.data(nodes);
                var newNodes;
                newNodes = nodeSelection
                    .enter()
                        .append('svg:g')
                        .attr('class', 'node');
                newNodes
                    .append('svg:circle')
                        .attr('r', 9)
                        .on('mousedown', handleNodeClick)
                        .on('dblclick', handleNodeDblclick)
                        .call(nodeDrag);
                newNodes
                    .append('svg:text')
                        .attr('class', 'title')
                        .attr('dx', 4)
                        .attr('dy', -4)
                        .text(function (d) { return d.title })
                        .on('mousedown', handleLabelClick);


                // newNodes
                //     .append("foreignObject")
                //         .attr("width", 100)
                //         .attr("height", 150)
                //         .attr("x", -50)
                //         .attr("y", -75)
                //     .append("xhtml:body")
                //         .style("font", "14px 'Helvetica Neue'")
                //         .html("<a href=\"http://google.com\"><h1>h1</h1></a><img src=\"/img/meta.png\" width=\"220\" height=\"auto\"><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec eu enim quam. Quisque nisi risus, sagittis quis tempor nec, aliquam eget neque. Nulla bibendum semper lorem non ullamcorper. Nulla non ligula lorem. Praesent porttitor, tellus nec suscipit aliquam, enim elit posuere lorem, at laoreet enim ligula sed tortor. Ut sodales, urna a aliquam semper, nibh diam gravida sapien, sit amet fermentum purus lacus eget massa. Donec ac arcu vel magna consequat pretium et vel ligula. Donec sit amet erat elit. Vivamus eu metus eget est hendrerit rutrum. Curabitur vitae orci et leo interdum egestas ut sit amet dui. In varius enim ut sem posuere in tristique metus ultrices.<p>Integer mollis massa at orci porta vestibulum. Pellentesque dignissim turpis ut tortor ultricies condimentum et quis nibh. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer euismod lorem vulputate dui pharetra luctus. Sed vulputate, nunc quis porttitor scelerisque, dui est varius ipsum, eu blandit mauris nibh pellentesque tortor. Vivamus ultricies ante eget ipsum pulvinar ac tempor turpis mollis. Morbi tortor orci, euismod vel sagittis ac, lobortis nec est. Quisque euismod venenatis felis at dapibus. Vestibulum dignissim nulla ut nisi tristique porttitor. Proin et nunc id arcu cursus dapibus non quis libero. Nunc ligula mi, bibendum non mattis nec, luctus id neque. Suspendisse ut eros lacus. Praesent eget lacus eget risus congue vestibulum. Morbi tincidunt pulvinar lacus sed faucibus. Phasellus sed vestibulum sapien.");



                // keep things moving
                force.start();

            }


            // get random +/- jitter
            function getJitter(factor) {
                var jitter = factor * Math.random();
                if (Math.random() > 0.5) { jitter -= jitter * 2; }
                return jitter;
            }


            // interface
            return {
                addNode: addNode,
                resize: resize
            }

        })();

        forceGraph.resize(4000, 4000);

        var posterTree = {
            title: 'Wikitree',
            children: [
                {
                    title: 'Visualizations',
                    children: [
                        {
                            title: 'Data'
                        },
                        {
                            title: 'Information'
                        },
                        {
                            title: 'Knowledge'
                        },
                        {
                            title: 'Wisdom'
                        },
                    ]
                },
                {
                    title: 'Undergraduate research',
                    children: [
                        {
                            title: 'Learning'
                        },
                        {
                            title: 'Studying'
                        },
                        {
                            title: 'Essays'
                        },
                    ]
                },
                {
                    title: 'Web technologies',
                    children: [
                        {
                            title: 'AngularJS',
                        },
                        {
                            title: 'Node.js',
                        },
                        {
                            title: 'MediaWiki API',
                        }
                    ]
                },
                {
                    title: 'Wikipedia',
                    children: [
                        {
                            title: 'Encyclopedia',
                        },
                        {
                            title: 'Free access'
                        },
                        {
                            title: 'Free content'
                        },
                        {
                            title: 'Democratic'
                        },
                    ]
                },
            ]
        };



        var safeCycleGraph = {

        };






        function makePoster(node, sourceIndex) {

            var nodeIndex = forceGraph.addNode(
                node.title,
                sourceIndex
            );

            if (!node.children) return;

            node.children.forEach(function (nodeChild) {
                makePoster(
                    nodeChild,
                    nodeIndex
                );
            });

        }


        makePoster(posterTree, -1);





    </script>
</body>
</html>
